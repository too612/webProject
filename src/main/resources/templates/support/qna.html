<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<head>
    <title>작은도서관 - 질문과답변</title>
    <th:block layout:fragment="css">
        <!-- Material Icons (파일 아이콘 등을 위해 추가) -->
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <style>
            /* Q&A 페이지 전용 스타일 */
            .qna-content-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                padding-bottom: 20px;
                border-bottom: 1px solid #e9ecef;
                margin-bottom: 20px;
            }
            .qna-content-header h2 {
                margin: 0;
                font-size: 24px;
                font-weight: 600;
            }
            .breadcrumb-right {
                font-size: 14px;
                color: #6c757d;
                padding-top: 8px;
            }
            .status-badge {
                display: inline-block;
                padding: 3px 8px;
                font-size: 12px;
                font-weight: 600;
                border-radius: 12px;
                color: white;
                background-color: #4CAF50; /* 답변 완료 (녹색) */
                margin-right: 8px;
                vertical-align: middle;
            }
            .table-container {
                overflow-x: auto;
            }
            table {
                width: 100%;
                border-collapse: collapse;
            }
            th, td {
                padding: 16px;
                text-align: left;
                border-bottom: 1px solid #e0e0e0;
            }
            th {
                background: #f8f9fa;
                font-weight: 600;
            }
            .post-title {
                font-weight: 500;
            }
            .post-title:hover {
                color: #2196F3;
            }
            .pagination {
                display: flex;
                justify-content: center;
                padding: 30px 0;
                gap: 5px;
            }
            .pagination a {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 40px;
                height: 40px;
                color: #666;
                border: 1px solid #e0e0e0;
                border-radius: 6px;
                transition: all 0.2s;
            }
            .pagination a:hover {
                background: #f5f5f5;
            }
            .pagination a.active {
                background: #2196F3;
                color: white;
                border-color: #2196F3;
            }
            .search-area {
                border-top: 1px solid #e0e0e0;
                background: #f8f9fa;
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 10px;
                /* content-area의 padding(-30px) 만큼 확장하여 꽉 채움 */
                margin: 0 -30px -30px; 
                padding: 20px 30px;
            }
            .search-input-group {
                display: flex;
                gap: 10px;
                align-items: center;
            }
            .search-button-group {
                display: flex;
                gap: 10px;
            }
            .search-select, .search-input {
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 6px;
            }
            .search-input { width: 250px; }
            .search-btn {
                padding: 10px 20px;
                background: #2196F3;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
            }
            .search-btn:hover {
                background: #1976D2;
            }
            .material-icons.file-icon {
                font-size: 18px;
                color: #6c757d;
                vertical-align: middle;
            }
            /* 비밀번호 확인 모달 스타일 */
            .modal-overlay {
                display: none;
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1000;
                justify-content: center; align-items: center;
            }
            .modal-content {
                background: white; padding: 30px; border-radius: 8px;
                width: 400px; text-align: center;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            }
            .modal-title { font-size: 18px; font-weight: 600; margin-bottom: 20px; }
            .modal-input {
                width: 100%; padding: 10px; border: 1px solid #ddd;
                border-radius: 4px; margin-bottom: 20px; box-sizing: border-box;
            }
            .modal-btns { display: flex; gap: 10px; justify-content: center; }
            .modal-btn {
                padding: 8px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;
            }
            .btn-confirm { background: #2196F3; color: white; }
            .btn-cancel { background: #e0e0e0; color: #333; }
            .lock-icon {
                font-size: 16px; color: #ff9800; vertical-align: middle; margin-right: 4px;
            }

            /* 보기 방식 토글 버튼 스타일 */
            .view-mode-controls {
                display: flex;
                gap: 5px;
                align-items: center;
            }
            .view-mode-btn {
                background: #fff;
                border: 1px solid #ddd;
                border-radius: 4px;
                padding: 5px;
                cursor: pointer;
                color: #666;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .view-mode-btn.active {
                background: #2196F3;
                color: white;
                border-color: #2196F3;
            }

            /* 갤러리형(카드형) 스타일 */
            .gallery-container {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 20px;
                padding: 10px 0 30px 0;
            }
            .gallery-item {
                border: 1px solid #eee;
                border-radius: 8px;
                overflow: hidden;
                transition: transform 0.2s, box-shadow 0.2s;
                background: #fff;
                display: flex;
                flex-direction: column;
            }
            .gallery-item:hover {
                transform: translateY(-5px);
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            }
            .gallery-thumb {
                height: 160px;
                background-color: #f8f9fa;
                overflow: hidden;
                position: relative;
                display: flex;
                align-items: center;
                justify-content: center;
                border-bottom: 1px solid #eee;
            }
            .gallery-thumb img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                transition: transform 0.3s;
            }
            .gallery-item:hover .gallery-thumb img {
                transform: scale(1.05);
            }
            .gallery-body {
                padding: 15px;
                flex: 1;
                display: flex;
                flex-direction: column;
            }
            .gallery-title {
                font-size: 16px;
                font-weight: 600;
                margin-bottom: 8px;
                color: #333;
                text-decoration: none;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
                line-height: 1.4;
            }
            .gallery-meta {
                margin-top: auto;
                font-size: 12px;
                color: #888;
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding-top: 10px;
                border-top: 1px solid #f5f5f5;
            }
            .no-image-placeholder {
                color: #ccc;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 5px;
            }

            /* =============================
               모바일 전용 리스트 뷰
               ============================= */
            .mobile-list-container {
                display: none; /* 기본적으로 숨김 */
            }

            @media (max-width: 768px) {
                /* 모바일에서는 PC용 리스트/갤러리 숨기고 모바일 리스트만 표시 */
                #listViewContainer,
                #galleryViewContainer,
                .view-mode-controls {
                    display: none !important;
                }

                .mobile-list-container {
                    display: block !important;
                }

                /* 헤더 영역 조정 */
                .qna-content-header {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 10px;
                }

                .qna-content-header h2 {
                    font-size: 20px;
                }

                .content-stats {
                    font-size: 12px;
                }

                /* 모바일 리스트 아이템 */
                .mobile-list-item {
                    display: flex;
                    gap: 12px;
                    padding: 15px;
                    border-bottom: 1px solid #e9ecef;
                    background: white;
                    transition: background 0.2s;
                }

                .mobile-list-item:hover {
                    background: #f8f9fa;
                }

                .mobile-list-item:last-child {
                    border-bottom: none;
                }

                /* 썸네일 영역 */
                .mobile-thumb {
                    position: relative;
                    flex-shrink: 0;
                    width: 80px;
                    height: 80px;
                    border-radius: 8px;
                    overflow: hidden;
                    background: #f0f0f0;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }

                .mobile-thumb img {
                    width: 100%;
                    height: 100%;
                    object-fit: cover;
                }

                .mobile-thumb .no-image-icon {
                    font-size: 32px;
                    color: #ccc;
                }

                .mobile-thumb .image-count {
                    position: absolute;
                    bottom: 4px;
                    right: 4px;
                    background: rgba(0, 0, 0, 0.7);
                    color: white;
                    padding: 2px 6px;
                    border-radius: 10px;
                    font-size: 11px;
                    font-weight: 600;
                }

                /* 콘텐츠 영역 */
                .mobile-content {
                    flex: 1;
                    min-width: 0; /* 텍스트 오버플로우 처리를 위해 필요 */
                    display: flex;
                    flex-direction: column;
                    justify-content: space-between;
                }

                .mobile-title {
                    font-size: 15px;
                    font-weight: 600;
                    color: #333;
                    line-height: 1.4;
                    margin-bottom: 8px;
                    display: -webkit-box;
                    -webkit-line-clamp: 2;
                    -webkit-box-orient: vertical;
                    overflow: hidden;
                    word-break: break-word;
                }

                .mobile-title .lock-icon {
                    font-size: 14px;
                    color: #ff9800;
                    vertical-align: middle;
                }

                .mobile-title .reply-icon {
                    font-size: 14px;
                    color: #999;
                    vertical-align: middle;
                    margin-right: 4px;
                }

                .mobile-meta {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    font-size: 12px;
                    color: #666;
                    gap: 8px;
                }

                .mobile-meta-left {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    flex-wrap: wrap;
                    flex: 1;
                }

                .mobile-meta-item {
                    display: flex;
                    align-items: center;
                    gap: 3px;
                    white-space: nowrap;
                }

                .mobile-meta-item .material-icons {
                    font-size: 14px;
                    vertical-align: middle;
                }

                .mobile-meta-right {
                    color: #999;
                    font-size: 11px;
                    white-space: nowrap;
                }

                /* 검색 영역 모바일 최적화 */
                .search-area {
                    flex-direction: column;
                    gap: 12px;
                    padding: 15px;
                }

                /* 검색 입력 그룹 (구분 + 입력창) */
                .search-input-group {
                    display: flex;
                    gap: 8px;
                    width: 100%;
                }

                .search-select {
                    flex: 0 0 auto;
                    width: 90px;
                    padding: 12px 8px;
                    font-size: 14px;
                }

                .search-input {
                    flex: 1;
                    padding: 12px;
                    font-size: 14px;
                }

                /* 버튼 그룹 */
                .search-button-group {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 8px;
                }

                .search-btn {
                    padding: 12px;
                    font-size: 14px;
                    font-weight: 600;
                }

                #write {
                    background: #4CAF50;
                }

                #write:hover {
                    background: #45a049;
                }

                /* 페이지네이션 모바일 최적화 */
                .pagination {
                    padding: 20px 0;
                    flex-wrap: wrap;
                }

                .pagination a {
                    width: 35px;
                    height: 35px;
                    font-size: 14px;
                }

                /* 모달 모바일 최적화 */
                .modal-content {
                    width: 90%;
                    max-width: 350px;
                    padding: 20px;
                }
            }
        </style>
    </th:block>
</head>
<body>
    <!-- layout.html의 content 프래그먼트에 삽입될 내용 -->
    <div layout:fragment="content">
        <!-- 메시지 표시 영역 -->
        <div th:if="${message}" class="alert alert-info" role="alert" style="margin-bottom: 20px; padding: 15px; background-color: #d1ecf1; border: 1px solid #bee5eb; border-radius: 4px;">
            <p th:text="${message}" style="margin: 0;"></p>
        </div>

        <div class="qna-content-header">
            <div>
                <h2>질문과 답변</h2>
                <!-- paging 객체가 null일 경우를 대비해 null 체크 추가 -->
                <div class="content-stats" th:if="${paging != null and !paging.isEmpty()}">게시물 수: <span th:text="${paging.totalElements}">0</span> | 페이지: <span th:text="${paging.number + 1}">0</span>/<span th:text="${paging.totalPages}">0</span></div>
            </div>
            
            <!-- 보기 방식 선택 버튼 -->
            <div class="view-mode-controls">
                <button type="button" class="view-mode-btn active" id="btnListView" title="목록형 보기">
                    <span class="material-icons">format_list_bulleted</span>
                </button>
                <button type="button" class="view-mode-btn" id="btnGalleryView" title="갤러리형 보기">
                    <span class="material-icons">grid_view</span>
                </button>
            </div>
        </div>

        <!-- 1. 리스트형 보기 (기존 테이블) -->
        <div id="listViewContainer" class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width: 8%;">번호</th>
                        <th style="width: 10%; display: none;">Key</th>
                        <th>제목</th>
                        <th style="width: 8%;">첨부</th>
                        <th style="width: 12%;">작성자</th>
                        <th style="width: 10%;">조회수</th>
                        <th style="width: 15%;">등록일</th>
                    </tr>
                </thead>
                <tbody th:if="${!#lists.isEmpty(boards)}">
                    <!-- iterStat을 사용하여 반복 상태(index 등)에 접근 -->
                    <tr th:each="board, iterStat : ${boards}">
                        <!-- 전체 게시물 수에서 (현재페이지 * 페이지사이즈 + 현재 index)를 빼서 역순 번호 계산 -->
                        <!-- paging이 null이면 단순히 1부터 순서대로 출력하도록 수정 -->
                        <td th:text="${paging != null ? (paging.totalElements - (paging.number * paging.size) - iterStat.index) : iterStat.count}">번호</td>
                        <td th:text="${board.rqstNo}" style="display: none;">Key</td>
                        <td style="text-align: left;">
                            <!-- 답글인 경우 들여쓰기 및 아이콘 표시 (depth가 있다고 가정) -->
                            <span th:if="${board.depth > 0}" th:style="'padding-left:' + ${board.depth * 15} + 'px'">
                                <span class="material-icons" style="font-size: 14px; color: #999;">subdirectory_arrow_right</span>
                            </span>
                            <!-- 상세 보기 페이지(view)로 이동하도록 변경 -->
                            <!-- 비밀글이 아닌 경우 -->
                            <a th:if="${board.secret != 'Y'}" th:href="@{/board/view(rqstNo=${board.rqstNo})}" class="post-title">
                                <span th:text="${board.title}">게시글 제목</span>
                                <span th:if="${board.commentCount > 0}" th:text="'[' + ${board.commentCount} + ']'" style="color: #ff5722; font-weight: bold; font-size: 0.9em; margin-left: 5px;"></span>
                            </a>
                            <!-- 비밀글인 경우 -->
                            <a th:if="${board.secret == 'Y'}" href="javascript:void(0);" 
                               th:data-rqst-no="${board.rqstNo}"
                               onclick="openPasswordModal(this.getAttribute('data-rqst-no'))"
                               class="post-title" style="cursor: pointer;">
                                <span class="material-icons lock-icon">lock</span>
                                <span th:text="${board.title}">게시글 제목</span>
                                <span th:if="${board.commentCount > 0}" th:text="'[' + ${board.commentCount} + ']'" style="color: #ff5722; font-weight: bold; font-size: 0.9em; margin-left: 5px;"></span>
                            </a>
                        </td>
                        <!-- 파일 첨부 여부 아이콘 (hasFile 필드가 있다고 가정) -->
                        <td style="text-align: center;">
                            <span th:if="${board.hasFile}" class="material-icons file-icon">attach_file</span>
                        </td>
                        <td th:text="${board.rqstId}">작성자</td>
                        <td style="text-align: center;" th:text="${board.views}">0</td>
                        <td th:text="${board.insDt != null ? #temporals.format(board.insDt, 'yyyy-MM-dd') : ''}">2025-01-01</td>
                    </tr>
                </tbody>
                <tbody th:if="${#lists.isEmpty(boards)}">
                    <tr>
                        <!-- 보이는 컬럼 수(번호, 제목, 첨부, 작성자, 조회수, 등록일)에 맞춰 6으로 수정 -->
                        <td colspan="6" style="text-align: center;">게시글이 없습니다.</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 2. 갤러리형 보기 (새로 추가) -->
        <div id="galleryViewContainer" class="gallery-container" style="display: none;">
            <th:block th:if="${!#lists.isEmpty(boards)}">
                <div th:each="board : ${boards}" class="gallery-item">
                    <!-- 썸네일 영역 -->
                    <a th:href="${board.secret != 'Y'} ? @{/board/view(rqstNo=${board.rqstNo})} : 'javascript:void(0);'"
                       th:data-rqst-no="${board.rqstNo}"
                       th:data-secret="${board.secret}"
                       onclick="if(this.getAttribute('data-secret') === 'Y') { openPasswordModal(this.getAttribute('data-rqst-no')); }"
                       class="gallery-thumb">
                        
                        <!-- 
                           [참고] 실제 썸네일 이미지를 표시하려면 백엔드에서 썸네일 URL을 제공하거나, 
                           본문(cont) 내용을 파싱해야 합니다. 여기서는 본문 내용이 모델에 있다고 가정하고
                           스크립트로 이미지를 추출하거나 기본 아이콘을 표시합니다.
                        -->
                        <!-- 이미지가 있을 경우 (스크립트로 src 처리 예정) -->
                        <img th:id="'thumb-' + ${board.rqstNo}" class="post-thumbnail" style="display: none;" alt="썸네일">
                        
                        <!-- 이미지가 없을 경우 기본 플레이스홀더 -->
                        <div th:id="'no-thumb-' + ${board.rqstNo}" class="no-image-placeholder">
                            <span class="material-icons" style="font-size: 48px;">image_not_supported</span>
                        </div>
                    </a>

                    <div class="gallery-body">
                        <a th:href="${board.secret != 'Y'} ? @{/board/view(rqstNo=${board.rqstNo})} : 'javascript:void(0);'"
                           th:data-rqst-no="${board.rqstNo}"
                           th:data-secret="${board.secret}"
                           onclick="if(this.getAttribute('data-secret') === 'Y') { openPasswordModal(this.getAttribute('data-rqst-no')); }"
                           class="gallery-title">
                            <span th:if="${board.secret == 'Y'}"><i class="material-icons" style="font-size: 14px; vertical-align: middle; color: #ff9800;">lock</i></span>
                            <span th:text="${board.title}">게시글 제목</span>
                        </a>
                        <div class="gallery-meta">
                            <span th:text="${board.rqstId}">작성자</span>
                            <span>
                                <i class="material-icons" style="font-size: 12px; vertical-align: middle;">visibility</i> <span th:text="${board.views}">0</span>
                                <span style="margin: 0 5px;">|</span>
                                <span th:text="${board.insDt != null ? #temporals.format(board.insDt, 'yyyy-MM-dd') : ''}">날짜</span>
                            </span>
                        </div>
                    </div>

                    <!-- 본문 내용을 숨겨진 데이터로 저장 (이미지 추출용) - a 태그 밖으로 이동하여 중첩 링크 문제 방지 -->
                    <div th:id="'content-' + ${board.rqstNo}" style="display: none;" th:utext="${board.cont}"></div>
                </div>
            </th:block>
            <div th:if="${#lists.isEmpty(boards)}" style="grid-column: 1 / -1; text-align: center; padding: 50px; color: #666;">
                게시글이 없습니다.
            </div>
        </div>

        <!-- 3. 모바일 전용 리스트 뷰 -->
        <div class="mobile-list-container">
            <th:block th:if="${!#lists.isEmpty(boards)}">
                <div th:each="board : ${boards}" class="mobile-list-item" th:attr="data-depth=${board.depth}">
                    <!-- 썸네일 영역 -->
                    <a th:href="${board.secret != 'Y'} ? @{/board/view(rqstNo=${board.rqstNo})} : 'javascript:void(0);'"
                       th:data-rqst-no="${board.rqstNo}"
                       th:data-secret="${board.secret}"
                       th:onclick="${board.secret == 'Y'} ? 'openPasswordModal(this.getAttribute(\'data-rqst-no\')); return false;' : ''"
                       class="mobile-thumb">
                        <img th:id="'mobile-thumb-' + ${board.rqstNo}" style="display: none;" alt="썸네일">
                        <span th:id="'mobile-no-thumb-' + ${board.rqstNo}" class="material-icons no-image-icon">image</span>
                        <span th:id="'mobile-img-count-' + ${board.rqstNo}" class="image-count" style="display: none;"></span>
                    </a>

                    <!-- 본문 내용 숨김 (이미지 추출용) -->
                    <div th:id="'mobile-content-' + ${board.rqstNo}" style="display: none;" th:utext="${board.cont}"></div>

                    <!-- 콘텐츠 영역 -->
                    <div class="mobile-content">
                        <a th:href="${board.secret != 'Y'} ? @{/board/view(rqstNo=${board.rqstNo})} : 'javascript:void(0);'"
                           th:data-rqst-no="${board.rqstNo}"
                           th:data-secret="${board.secret}"
                           th:onclick="${board.secret == 'Y'} ? 'openPasswordModal(this.getAttribute(\'data-rqst-no\')); return false;' : ''"
                           class="mobile-title">
                            <!-- 답글 화살표 -->
                            <span th:if="${board.depth > 0}" class="material-icons reply-icon">subdirectory_arrow_right</span>
                            <span th:if="${board.secret == 'Y'}"><i class="material-icons lock-icon">lock</i></span>
                            <span th:text="${board.title}">게시글 제목</span>
                        </a>

                        <div class="mobile-meta">
                            <div class="mobile-meta-left">
                                <!-- 파일 크기 (첨부파일이 있을 경우) -->
                                <span th:if="${board.hasFile}" class="mobile-meta-item" 
                                      th:attr="data-file-size=${board.totalFileSize}">
                                    <i class="material-icons">attach_file</i>
                                    <span class="file-size-text">-</span>
                                </span>
                                <!-- 조회수 -->
                                <span class="mobile-meta-item">
                                    <i class="material-icons">visibility</i>
                                    <span th:text="${board.views ?: 0}">0</span>
                                </span>
                                <!-- 댓글 수 -->
                                <span th:if="${board.commentCount > 0}" class="mobile-meta-item">
                                    <i class="material-icons">comment</i>
                                    <span th:text="${board.commentCount}">0</span>
                                </span>
                            </div>
                            <!-- 상대 시간 -->
                            <div class="mobile-meta-right" th:attr="data-date=${board.insDt}">
                                <span th:text="${board.insDt != null ? #temporals.format(board.insDt, 'yyyy-MM-dd') : ''}">날짜</span>
                            </div>
                        </div>
                    </div>
                </div>
            </th:block>
            <div th:if="${#lists.isEmpty(boards)}" style="text-align: center; padding: 50px; color: #666;">
                게시글이 없습니다.
            </div>
        </div>

        <!-- Pagination -->
        <div class="pagination" th:if="${paging != null and !paging.isEmpty()}">
            <!--/*
                페이지네이션 로직:
                - paging: Spring Data의 Page 객체
                - number: 현재 페이지 (0부터 시작)
                - totalPages: 전체 페이지 수
                - size: 페이지당 보여줄 항목 수 (여기서는 10으로 가정)
            */-->
            <!-- 처음으로 이동 -->
            <a th:href="@{/board(page=0, searchType=${param.searchType}, keyword=${param.keyword})}" th:if="${paging.number > 0}"><span>&laquo;</span></a>
            <!-- 이전 블록으로 이동 -->
            <a th:href="@{/board(page=${(paging.number/10)*10 - 1}, searchType=${param.searchType}, keyword=${param.keyword})}" th:if="${paging.number >= 10}"><span>&lt;</span></a>
        
            <!-- 페이지 번호 -->
            <a th:each="page: ${#numbers.sequence( (paging.number/10)*10 + 1, T(java.lang.Math).min((paging.number/10)*10 + 10, paging.totalPages) )}"
               th:href="@{/board(page=${page - 1}, searchType=${param.searchType}, keyword=${param.keyword})}"
               th:text="${page}"
               th:classappend="${page == paging.number + 1} ? 'active' : ''"></a>
        
            <!-- 다음 블록으로 이동 -->
            <a th:href="@{/board(page=${(paging.number/10)*10 + 10}, searchType=${param.searchType}, keyword=${param.keyword})}" th:if="${(paging.number/10)*10 + 10 < paging.totalPages}"><span>&gt;</span></a>
            <!-- 마지막으로 이동 -->
            <a th:href="@{/board(page=${paging.totalPages - 1}, searchType=${param.searchType}, keyword=${param.keyword})}" th:if="${paging.number < paging.totalPages - 1}"><span>&raquo;</span></a>
        </div>

        <div class="search-area">
            <!-- 검색 입력 그룹 -->
            <div class="search-input-group">
                <select id="searchType" class="search-select" name="searchType">
                    <option value="title" th:selected="${param.searchType == 'title'}">제목</option>
                    <option value="cont" th:selected="${param.searchType == 'cont'}">내용</option>
                    <option value="rqstId" th:selected="${param.searchType == 'rqstId'}">작성자</option>
                </select>
                <input id="keyword" type="text" class="search-input" placeholder="검색어를 입력하세요" name="keyword" th:value="${param.keyword}">
            </div>
            <!-- 버튼 그룹 -->
            <div class="search-button-group">
                <button class="search-btn" id="search">검색</button>
                <button class="search-btn" id="write">글쓰기</button>
            </div>
        </div>
    
        <!-- 비밀번호 확인 모달 -->
        <div id="passwordModal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-title">비밀글 열람</div>
                <p style="font-size: 14px; color: #666; margin-bottom: 15px;">이 게시글은 비밀글입니다.<br>비밀번호를 입력해주세요.</p>
                <!-- 비밀번호 확인을 위한 POST 전송 -->
                <form id="passwordForm" action="/board/view" method="post">
                    <input type="hidden" id="modalRqstNo" name="rqstNo">
                    <input type="password" class="modal-input" name="password" placeholder="비밀번호 입력" required>
                    <div class="modal-btns">
                        <button type="button" class="modal-btn btn-cancel" onclick="closePasswordModal()">취소</button>
                        <button type="submit" class="modal-btn btn-confirm">확인</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <th:block layout:fragment="scripts">
        <script>
            // 페이지네이션, 검색 등 이 페이지에만 필요한 스크립트
            document.getElementById('search').addEventListener('click', function() {
                const searchType = document.getElementById('searchType').value;
                const keyword = document.getElementById('keyword').value;

                if (!keyword.trim()) {
                    alert('검색어를 입력해주세요.');
                    return;
                }

                location.href = '/board?searchType=' + searchType + '&keyword=' + encodeURIComponent(keyword);
            });

            document.getElementById('write').addEventListener('click', function() {
                location.href = '/board/write';
            });

            // 비밀번호 모달 관련 스크립트
            function openPasswordModal(rqstNo) {
                document.getElementById('modalRqstNo').value = rqstNo;
                document.getElementById('passwordModal').style.display = 'flex';
                document.querySelector('#passwordModal input[type="password"]').focus();
            }

            function closePasswordModal() {
                document.getElementById('passwordModal').style.display = 'none';
                document.getElementById('passwordForm').reset();
            }

            // 모달 배경 클릭 시 닫기
            document.getElementById('passwordModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closePasswordModal();
                }
            });

            // --- 상대 시간 변환 함수 ---
            function getRelativeTime(dateString) {
                if (!dateString) return '';
                
                const date = new Date(dateString);
                const now = new Date();
                const diffMs = now - date;
                const diffSec = Math.floor(diffMs / 1000);
                const diffMin = Math.floor(diffSec / 60);
                const diffHour = Math.floor(diffMin / 60);
                const diffDay = Math.floor(diffHour / 24);
                const diffWeek = Math.floor(diffDay / 7);
                const diffMonth = Math.floor(diffDay / 30);
                const diffYear = Math.floor(diffDay / 365);

                if (diffSec < 60) return diffSec + '초 전';
                if (diffMin < 60) return diffMin + '분 전';
                if (diffHour < 24) return diffHour + '시간 전';
                if (diffDay < 7) return diffDay + '일 전';
                if (diffWeek < 4) return diffWeek + '주 전';
                if (diffMonth < 12) return diffMonth + '개월 전';
                return diffYear + '년 전';
            }

            // --- 파일 크기 포맷 함수 ---
            function formatFileSize(bytes) {
                if (!bytes || bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return (bytes / Math.pow(k, i)).toFixed(1) + ' ' + sizes[i];
            }

            // --- 보기 방식 전환 스크립트 ---
            
            // 페이지 로드 시 저장된 보기 방식 적용 및 썸네일 추출
            document.addEventListener('DOMContentLoaded', function() {
                const savedMode = localStorage.getItem('qnaViewMode') || 'list';
                
                // 버튼 이벤트 리스너 등록 (모바일에서는 숨겨짐)
                const btnList = document.getElementById('btnListView');
                const btnGallery = document.getElementById('btnGalleryView');
                
                if (btnList && btnGallery) {
                    btnList.addEventListener('click', function() { setViewMode('list'); });
                    btnGallery.addEventListener('click', function() { setViewMode('gallery'); });
                    setViewMode(savedMode);
                }

                extractThumbnails();
                extractMobileThumbnails();
                updateRelativeTimes();
                updateFileSizes();
            });

            function setViewMode(mode) {
                const listView = document.getElementById('listViewContainer');
                const galleryView = document.getElementById('galleryViewContainer');
                const btnList = document.getElementById('btnListView');
                const btnGallery = document.getElementById('btnGalleryView');

                if (mode === 'gallery') {
                    listView.style.display = 'none';
                    galleryView.style.display = 'grid';
                    btnList.classList.remove('active');
                    btnGallery.classList.add('active');
                } else {
                    listView.style.display = 'block';
                    galleryView.style.display = 'none';
                    btnList.classList.add('active');
                    btnGallery.classList.remove('active');
                }
                
                // 설정 저장
                localStorage.setItem('qnaViewMode', mode);
            }

            // 본문 내용에서 첫 번째 이미지를 추출하여 썸네일로 표시하는 함수
            function extractThumbnails() {
                const items = document.querySelectorAll('.gallery-item');
                console.log('[썸네일 추출 시작] 총 ' + items.length + '개의 게시글을 확인합니다.');
                items.forEach(item => {
                    // 각 아이템의 숨겨진 본문 영역 찾기
                    const contentDiv = item.querySelector('div[id^="content-"]');
                    // rqstNo 가져오기 (썸네일 영역의 data 속성)
                    const rqstNo = item.querySelector('.gallery-thumb').getAttribute('data-rqst-no');

                    if (!contentDiv) {
                        console.log('[오류] 게시글 ' + rqstNo + ': 본문 영역(content div)을 찾을 수 없습니다.');
                        return;
                    }

                    const thumbImg = document.getElementById('thumb-' + rqstNo);
                    const noThumbDiv = document.getElementById('no-thumb-' + rqstNo);

                    // 1. 먼저 본문에 렌더링된 img 태그가 있는지 확인
                    let firstImg = contentDiv.querySelector('img');
                    
                    if (firstImg && firstImg.src && thumbImg) {
                        // 이미지가 있으면 src 복사 및 표시
                        thumbImg.src = firstImg.src;
                        thumbImg.style.display = 'block';
                        if(noThumbDiv) noThumbDiv.style.display = 'none';
                        console.log('[성공] 게시글 ' + rqstNo + ': 이미지를 찾았습니다. (src: ' + firstImg.src.substring(0, 50) + '...)');
                    } else {
                        // 2. img 태그가 없다면 base64 패턴을 직접 검색
                        const content = contentDiv.innerHTML;
                        const base64Pattern = /data:image\/(png|jpeg|jpg|gif|webp);base64,[A-Za-z0-9+\/=]+/i;
                        const match = content.match(base64Pattern);
                        
                        if (match && thumbImg) {
                            thumbImg.src = match[0];
                            thumbImg.style.display = 'block';
                            if(noThumbDiv) noThumbDiv.style.display = 'none';
                            console.log('[성공] 게시글 ' + rqstNo + ': base64 이미지를 찾았습니다.');
                        } else {
                            // 이미지가 없으면 기본 아이콘 유지
                            console.log('[실패] 게시글 ' + rqstNo + ': 이미지를 찾을 수 없습니다. 본문 앞부분: ' + content.substring(0, 100));
                        }
                    }
                });
            }

            // 모바일 썸네일 추출 함수
            function extractMobileThumbnails() {
                const items = document.querySelectorAll('.mobile-list-item');
                console.log('[모바일 썸네일 추출] 총 ' + items.length + '개의 게시글 처리');
                
                items.forEach(item => {
                    const contentDiv = item.querySelector('div[id^="mobile-content-"]');
                    if (!contentDiv) return;

                    const rqstNo = contentDiv.id.replace('mobile-content-', '');
                    const thumbImg = document.getElementById('mobile-thumb-' + rqstNo);
                    const noThumbIcon = document.getElementById('mobile-no-thumb-' + rqstNo);
                    const imgCountBadge = document.getElementById('mobile-img-count-' + rqstNo);

                    // 이미지 태그 모두 찾기
                    const allImages = contentDiv.querySelectorAll('img');
                    const imageCount = allImages.length;

                    // 첫 번째 이미지 처리
                    if (imageCount > 0 && allImages[0].src) {
                        thumbImg.src = allImages[0].src;
                        thumbImg.style.display = 'block';
                        if (noThumbIcon) noThumbIcon.style.display = 'none';

                        // 이미지가 2개 이상이면 개수 표시
                        if (imageCount > 1 && imgCountBadge) {
                            imgCountBadge.textContent = '+' + imageCount;
                            imgCountBadge.style.display = 'block';
                        }
                    } else {
                        // base64 패턴 검색
                        const content = contentDiv.innerHTML;
                        const base64Pattern = /data:image\/(png|jpeg|jpg|gif|webp);base64,[A-Za-z0-9+\/=]+/gi;
                        const matches = content.match(base64Pattern);

                        if (matches && matches.length > 0) {
                            thumbImg.src = matches[0];
                            thumbImg.style.display = 'block';
                            if (noThumbIcon) noThumbIcon.style.display = 'none';

                            if (matches.length > 1 && imgCountBadge) {
                                imgCountBadge.textContent = '+' + matches.length;
                                imgCountBadge.style.display = 'block';
                            }
                        }
                    }
                });
            }

            // 상대 시간 업데이트
            function updateRelativeTimes() {
                const timeElements = document.querySelectorAll('.mobile-meta-right[data-date]');
                timeElements.forEach(el => {
                    const date = el.getAttribute('data-date');
                    if (date) {
                        const relativeTime = getRelativeTime(date);
                        el.querySelector('span').textContent = relativeTime;
                    }
                });
            }

            // 파일 크기 업데이트
            function updateFileSizes() {
                const fileSizeElements = document.querySelectorAll('.mobile-meta-item[data-file-size]');
                fileSizeElements.forEach(el => {
                    const fileSize = parseInt(el.getAttribute('data-file-size'));
                    if (fileSize && fileSize > 0) {
                        const formattedSize = formatFileSize(fileSize);
                        const textSpan = el.querySelector('.file-size-text');
                        if (textSpan) {
                            textSpan.textContent = formattedSize;
                        }
                    }
                });
            }
        </script>
    </th:block>
</body>
</html>